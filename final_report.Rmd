---
title: "Final_Report"
output: html_notebook
---


```{r}
h1b_df <- DATA
```


# SECTION 1: BACKGROUND
# SLIDE 7: MAP

```{r}
htmltools::includeHTML("rMaps.html")
```

# SECTION 2: STEM
# SLIDE 9: Stem and non-stem histogram
```{r fig.height=7, fig.width=6}
DATA %>%
  group_by(year, stem) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, fill = as.factor(stem))) +
  geom_bar(stat = "identity", position = position_stack(reverse = FALSE), alpha = 0.8) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  labs(title="The number of Certifited \n Applications throughout years: 2014 - 2018", y="Number", x="\n Year") + 
  scale_y_continuous(labels = function(x){paste0(x/1000, 'K')}) + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  theme(legend.position = "top")
```


# SLIDE 10: Stem and non-stem boxplot
```{r}
DATA %>%
  filter(prevailing_wage >= 0 & prevailing_wage <= 600000) %>%
  ggplot(aes(x = as.factor(year), y = prevailing_wage)) +
  geom_boxplot(aes(fill=as.factor(stem)), outlier.shape = NA, alpha=0.9, color = "white") +
  theme_minimal() +
 labs(x = "\n Prevailing wage ($)", y = "Density \n", title = "Distribution of prevailing wage in 2018") +
  scale_y_continuous(labels = function(x){paste0(x / 1000, "K")}) +
  scale_color_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  coord_cartesian(ylim = c(40000, 100000))
```


# SLIDE 11: Stem and non-stem prevailing wage distribution
```{r}
DATA %>%
  filter(year == 2018) %>%
  filter(prevailing_wage >= 0 & prevailing_wage <= 400000) %>% 
  ggplot(aes(x = prevailing_wage, color = as.factor(stem), fill = as.factor(stem))) +
  geom_density(adjust = 2, alpha = 0.7)+
  theme_classic() +
  labs(x = "\n Prevailing wage ($)", y = "Density \n", title = "Distribution of prevailing wage in 2018") +
  scale_x_continuous(labels = function(x){paste0(x/1000, 'K')}) +
  scale_y_continuous(labels = function(x){paste0(x * 1000, "* 10^3")}) +
  scale_color_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  theme(plot.title = element_text(hjust=0.5))
```


# SLIDE 12 AND 13: bar plot: stem jobs
```{r}
dt <- DATA %>% 
  mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "business analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "data engineer", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "scientist"), "data scientist", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "analyst|analytics"), "data analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep")& str_detect(job_title, "learning"), "deep learning & machine learning", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "data product analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "senior systems analyst jc60"), "senior systems analyst", job_title)) %>% 
  filter(stem == 1)

dt %>% 
  filter(year == 2017) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "cat", palette = c("red", "#00B2E4"), alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")

dt %>% 
  filter(year == 2018) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "cat", palette = c("red", "#00B2E4"), alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")+
  theme(
    legend.position = "none"
  )


# original
dt %>% 
  filter(year == 2018) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "#00B2E4", alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")
```


# Slide 17
# Top Tech Companies and Their Trends
```{r}
soc_top_tech <- c("Apple",
                  "Microsoft",
                  "Amazon",
                  "Facebook",
                  "Google",
                  "IBM",
                  "Cisco")


h1b_df %>% 
  filter(case_status ==  "certified") %>%
  mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "Business Analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "Data Engineer", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data") & str_detect(job_title, "scientist"), "Data Scientist", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data") & str_detect(job_title, "analyst"), "Data Analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep") & str_detect(job_title, "learning"), "Deep Learning & Machine Learning", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "Data Product Analyst", job_title)) %>% 
  filter(job_title %in% c("Business Analyst","Data Engineer","Deep Learning & Machine Learning","Data Analyst", "Data Scientist", "Data Product Analyst")) %>%
  mutate(employer_name = ifelse(str_detect(employer_name,'apple'), 'Apple',
                          ifelse(str_detect(employer_name,'microsoft'), 'Microsoft',
                          ifelse(str_detect(employer_name,'amazon'),'Amazon',
                          ifelse(str_detect(employer_name,'cisco sys'),'Cisco',
                          ifelse(str_detect(employer_name,'facebook'),'Facebook',
                          ifelse(str_detect(employer_name,'google'),'Google',
                          ifelse(str_detect(employer_name, 'ibm'),'IBM','no')))))))) %>% 
  group_by(employer_name, year) %>% 
  summarise(tot = n()) %>% 
  filter(!employer_name %in% c("no", NA)) %>% 
  ungroup()%>% 
  ggplot()+
  geom_line(aes(x = year, y = tot, color = employer_name), size = 1.05)+
  labs( y = "Number of Applications", x = "Year", color = "Employer")+
  theme_bw()


```



## Facebook

```{r}
h1b_facebook <- h1b_df %>% 
  filter(employer_name == 'facebook') %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
  
```



```{r}
con=c("Data Scientist","software engineer","Data Engineer",'research scientist')
ggplot(h1b_facebook, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Facebook",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_facebook, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))+
  scale_color_discrete(labels = c("Data Engineer", "Data Scientist", "Research Scientist","Software Engineer"))

```

## Amazon

```{r}

h1b_amazon <- h1b_df %>% 
  filter(str_detect(employer_name,'amazon')) %>% 
  ungroup(data_job_title) %>% 
  mutate(job_title=ifelse(str_detect(data_job_title,'software development engineer'), 'software development engineer', 
                   ifelse(str_detect(data_job_title,'technical program manager'), 'technical program manager',data_job_title)))%>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)

```

```{r}
con=c("Data Scientist","software development engineer","business analyst","Data Engineer","technical program manager")
ggplot(h1b_amazon, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Amazon",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_amazon, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Business Analyst", "Data Engineer", "Data Scientist","Software Development Engineer","Technical Program Manager"))
```


## Microsoft

```{r}
h1b_micro <- h1b_df %>% 
  filter(str_detect(employer_name,'microsoft')) %>% 
  ungroup(data_job_title) %>% 
  mutate(job_title=ifelse(str_detect(data_job_title,'software engineer|software development engineer'), 'software engineer', 
                   ifelse(str_detect(data_job_title,'program manager'), 'program manager',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
  
```

```{r}
con=c("Data Scientist","software engineer","program manager")
ggplot(h1b_micro, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Microsoft",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_micro, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Data Scientist","Program Manager","Software Engineer"))
```


## Google

```{r}
h1b_google <- h1b_df %>% 
  filter(str_detect(employer_name,'google')) 
  
```

```{r}
h1b_google <- h1b_google %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'software engineer',
              ifelse(str_detect(data_job_title,'hardware engineer'), 'hardware engineer',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("Data Scientist","software engineer","program manager","product manager","business analyst")
ggplot(h1b_google, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Google",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_google, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Business Analyst", "Data Scientist","Product Manager","Program Manager", "Software Engineer"))
```


## IBM 

```{r}
h1b_ibm <- h1b_df %>% 
  filter(str_detect(employer_name,'ibm')) 
  
```

```{r}
h1b_ibm <- h1b_ibm %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'software engineer',
              ifelse(str_detect(data_job_title,'hardware engineer'), 'hardware engineer',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("consultant","application developer","it specialist","software engineer","project manager")
ggplot(h1b_ibm, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in IBM",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_ibm, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))
```

## Uber

```{r}
h1b_uber <- h1b_df %>% 
  filter(str_detect(employer_name,'uber')) %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'Software Engineer', 
        data_job_title)) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("Software Engineer","Data Scientist","Data Analyst")
ggplot(h1b_uber, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Uber",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_uber, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))
```


## Alluvia
```{r}
filtered_job <- DATA %>% 
  filter(year == 2018) %>% 
  filter(data_job_title %in% c("Business Analyst","Data Analyst","Data Engineer", "Data Scientist"))


top_10_state <- filtered_job %>% 
  group_by(worksite_state_abb) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  slice(1:10) 

flows <- filtered_job %>% 
  filter(worksite_state_abb %in% top_10_state$worksite_state_abb) %>% 
  group_by(data_job_title,
           worksite_state_abb) %>%
  summarise(count = n())


ggplot(flows, aes(y =count, axis1=data_job_title, axis2=worksite_state_abb)) +
  geom_alluvium(aes(fill = data_job_title)) +
  geom_stratum(width = 1/8, fill = "black", color = "grey", alpha = 0.8) +
  geom_label(stat = "stratum", label.strata = TRUE) +
  theme_classic()+
  theme(legend.position = "bottom") +
  scale_fill_manual(values = c("#6ba8a9","#465881", "#999999", "#FC2967"))
```


## bar plot:stem program in different job titles
```{r}
DATA %>% 
  mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "business analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "data engineer", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "scientist"), "data scientist", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "analyst|analytics"), "data analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep")& str_detect(job_title, "learning"), "deep learning & machine learning", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "data product analyst", job_title)) %>% 
  filter(year == 2018) %>% 
  filter(stem == 1) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  ggbarplot("job_title", "n", fill = "#00B2E4", color = "white", alpha = 0.8, sort.val = "asc", orientation = "horiz") %>% 
  labs(title = "stem program")
```

# MAP - data job with the highest number in each city 
```{r}
ggplot(points) + 
  geom_sf(data = state_maps, color = "white", fill = "lightgrey",alpha=0.5) +
  geom_point(aes(x = jitter(lon,100), y = jitter(lat,100), color = max_job), size = 0.1, alpha = 0.5) + 
  scale_color_manual(values = c("Business Analyst" = "#00B2E4", 
                                "Data Analyst" = "#0F2A48",
                                "Data Engineer" = "#008B8B",
                                "Data Scientist" = "#FC2967"),
                     name = "Job Title") +
  theme(panel.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = c(0,0), legend.justification = c(0,0))+
  labs(x = "", y = "", title = "")
```

```{r}
ggplot(points_ca) + 
  geom_sf(data = state_maps_ca, color = "white", fill = "lightgrey",alpha=0.5) +
  geom_point(aes(x = jitter(lon,100), y = jitter(lat,100), color = max_job), size = 1, alpha = 0.5) + 
  scale_color_manual(values = c("Business Analyst" = "#00B2E4", 
                                "Data Analyst" = "#0F2A48",
                                "Data Engineer" = "#008B8B",
                                "Data Scientist" = "#FC2967"),
                     name = "Job Title") +
  theme(panel.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        #legend.position = c(0,0), legend.justification = c(0,0)
        )+
  labs(x = "", y = "", title = "")
```

```{r}
ggplot(points_west) + 
  geom_sf(data = state_maps_west, color = "white", fill = "lightgrey",alpha=0.5) +
  geom_point(aes(x = jitter(lon,100), y = jitter(lat,100), color = max_job), size = 1, alpha = 0.5) + 
  scale_color_manual(values = c("Business Analyst" = "#00B2E4", 
                                "Data Analyst" = "#0F2A48",
                                "Data Engineer" = "#008B8B",
                                "Data Scientist" = "#FC2967"),
                     name = "Job Title") +
  theme(panel.background = element_blank(),
        legend.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        #legend.position = c(0,0), legend.justification = c(0,0)
        )+
  labs(x = "", y = "", title = "")
```