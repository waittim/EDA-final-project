---
title: "Final_Report"
output: html_notebook
---


```{r}
h1b_df <- DATA
```

# Background

```{r}
htmltools::includeHTML("rMaps.html")
```

# Stem and non-stem histogram
```{r fig.height=7, fig.width=6}
DATA %>%
  group_by(year, stem) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, fill = as.factor(stem))) +
  geom_bar(stat = "identity", position = position_stack(reverse = FALSE), alpha = 0.8) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  labs(title="The number of Certifited \n Applications throughout years: 2014 - 2018", y="Number", x="\n Year") + 
  scale_y_continuous(labels = function(x){paste0(x/1000, 'K')}) + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust=0.5)) +
  theme(legend.position = "top")
```


# Stem and non-stem boxplot
```{r}
DATA %>%
  filter(prevailing_wage >= 0 & prevailing_wage <= 600000) %>%
  ggplot(aes(x = as.factor(year), y = prevailing_wage)) +
  geom_boxplot(aes(fill=stem), outlier.shape = NA, alpha=0.7, color = "white") +
  theme_minimal() +
 labs(x = "\n Prevailing wage ($)", y = "Density \n", title = "Distribution of prevailing wage in 2018") +
  scale_y_continuous(labels = function(x){paste0(x / 1000, "K")}) +
  scale_color_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  coord_cartesian(ylim = c(40000, 100000))
```


# Stem and non-stem prevailing wage distribution
```{r}
DATA %>%
  filter(year == 2018) %>%
  filter(prevailing_wage >= 0 & prevailing_wage <= 400000) %>% 
  ggplot(aes(x = prevailing_wage, color = as.factor(stem), fill = as.factor(stem))) +
  geom_density(adjust = 2, alpha = 0.7)+
  theme_classic() +
  labs(x = "\n Prevailing wage ($)", y = "Density \n", title = "Distribution of prevailing wage in 2018") +
  scale_x_continuous(labels = function(x){paste0(x/1000, 'K')}) +
  scale_y_continuous(labels = function(x){paste0(x * 1000, "* 10^3")}) +
  scale_color_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  scale_fill_manual(values = c("#00B2E4", "#0F2A48"), name = "field", labels = c("non-stem", "stem")) +
  theme(plot.title = element_text(hjust=0.5))
```


# bar plot: stem jobs
```{r}
dt <- DATA %>% 
  mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "business analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "data engineer", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "scientist"), "data scientist", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "analyst|analytics"), "data analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep")& str_detect(job_title, "learning"), "deep learning & machine learning", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "data product analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "senior systems analyst jc60"), "senior systems analyst", job_title)) %>% 
  filter(stem == 1)

dt %>% 
  filter(year == 2017) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "cat", palette = c("red", "#00B2E4"), alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")

dt %>% 
  filter(year == 2018) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "cat", palette = c("red", "#00B2E4"), alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")


# original
dt %>% 
  filter(year == 2018) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  mutate(cat = ifelse(str_detect(job_title, "analyst|data"), "data", "non-data")) %>%
  arrange(n) %>% 
  ggbarplot("job_title", "n", fill = "#00B2E4", alpha = 0.8, orientation = "horiz", color = "white") +
  labs(y = "Number of Aplications", x = "Job Titles")
```

## Facebook

```{r}
h1b_facebook <- h1b_df %>% 
  filter(employer_name == 'facebook') %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
  
```



```{r}
con=c("Data Scientist","software engineer","Data Engineer",'research scientist')
ggplot(h1b_facebook, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Facebook",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_facebook, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))+
  scale_color_discrete(labels = c("Data Engineer", "Data Scientist", "Research Scientist","Software Engineer"))

```

## Amazon

```{r}

h1b_amazon <- h1b_df %>% 
  filter(str_detect(employer_name,'amazon')) %>% 
  ungroup(data_job_title) %>% 
  mutate(job_title=ifelse(str_detect(data_job_title,'software development engineer'), 'software development engineer', 
                   ifelse(str_detect(data_job_title,'technical program manager'), 'technical program manager',data_job_title)))%>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)

```

```{r}
con=c("Data Scientist","software development engineer","business analyst","Data Engineer","technical program manager")
ggplot(h1b_amazon, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Amazon",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_amazon, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Business Analyst", "Data Engineer", "Data Scientist","Software Development Engineer","Technical Program Manager"))
```


## Microsoft

```{r}
h1b_micro <- h1b_df %>% 
  filter(str_detect(employer_name,'microsoft')) %>% 
  ungroup(data_job_title) %>% 
  mutate(job_title=ifelse(str_detect(data_job_title,'software engineer|software development engineer'), 'software engineer', 
                   ifelse(str_detect(data_job_title,'program manager'), 'program manager',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
  
```

```{r}
con=c("Data Scientist","software engineer","program manager")
ggplot(h1b_micro, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Microsoft",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_micro, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Data Scientist","Program Manager","Software Engineer"))
```


## Google

```{r}
h1b_google <- h1b_df %>% 
  filter(str_detect(employer_name,'google')) 
  
```

```{r}
h1b_google <- h1b_google %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'software engineer',
              ifelse(str_detect(data_job_title,'hardware engineer'), 'hardware engineer',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("Data Scientist","software engineer","program manager","product manager","business analyst")
ggplot(h1b_google, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Google",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_google, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11)) +
  scale_color_discrete(labels = c("Business Analyst", "Data Scientist","Product Manager","Program Manager", "Software Engineer"))
```


## IBM 

```{r}
h1b_ibm <- h1b_df %>% 
  filter(str_detect(employer_name,'ibm')) 
  
```

```{r}
h1b_ibm <- h1b_ibm %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'software engineer',
              ifelse(str_detect(data_job_title,'hardware engineer'), 'hardware engineer',data_job_title))) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("consultant","application developer","it specialist","software engineer","project manager")
ggplot(h1b_ibm, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in IBM",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_ibm, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))
```

## Uber

```{r}
h1b_uber <- h1b_df %>% 
  filter(str_detect(employer_name,'uber')) %>% 
  ungroup(data_job_title) %>% 
  mutate(data_job_title=ifelse(str_detect(data_job_title,'software engineer'), 'Software Engineer', 
        data_job_title)) %>% 
  group_by(data_job_title,year) %>% 
  summarise(n=n()) %>% 
  arrange(-n)
```

```{r}
con=c("Software Engineer","Data Scientist","Data Analyst")
ggplot(h1b_uber, aes(x = year, y = n, group = data_job_title)) +
  geom_line(alpha = 0.3, 
            size = 0.2) +
  labs(title = "H1B in Uber",
       x = "Year",
       y = "Number",
       col = 'Job Title') +
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5))+
   geom_line(data = subset(h1b_uber, data_job_title %in% con),aes(col=data_job_title),size=0.7)+
  theme(plot.title = element_text(size = 14, family = "Helvetica", face = "bold"),
              text = element_text(size = 12, family = "Helvetica"),
              axis.title = element_text(face="bold"),
              axis.text.x=element_text(size = 11))
```


## Alluvia
```{r}
filtered_job <- DATA %>% 
   mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "Business Analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "Data Engineer", job_title)) %>%
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "scientist"), "Data Scientist", job_title)) %>%
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "analyst|analytics"), "Data Analyst", job_title)) %>%
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep")& str_detect(job_title, "learning"), "Machine Learning", job_title)) %>%
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "Product Analyst", job_title)) %>%
  filter(job_title %in% c("Business Analyst","Data Engineer", "Data Scientist","Data Analyst", "Machine Learning & DL", "Product Analyst")) %>% 
  #filter(data_relation == "data_related") %>%
  filter(year == 2018)


top_10_state <- filtered_job %>% 
  group_by(worksite_state_abb) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  slice(1:10) 


flows <- filtered_job %>% 
  filter(worksite_state_abb %in% top_10_state$worksite_state_abb) %>% 
  group_by(job_title,
           worksite_state_abb) %>%
  summarise(count = n())


library(ggalluvial)

ggplot(flows, aes(y =count, axis1=job_title, axis2=worksite_state_abb)) +
  geom_alluvium(aes(fill = job_title)) +
  geom_stratum(width = 1/8, fill = "black", color = "grey") +
  geom_label(stat = "stratum", label.strata = TRUE) +
  theme_classic()+
  theme(legend.position = "bottom") +
  scale_fill_manual(values = c("#6ba8a9","#465881", "#00909e", "#00B2E4", "#FC2967", "#999999"))

```


## bar plot:stem program in different job titles
```{r}
DATA %>% 
  mutate(job_title = ifelse(str_detect(job_title, "business")& (str_detect(job_title, "analyst")|str_detect(job_title, "intelligence")) , "business analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& (str_detect(job_title, "engineer")|str_detect(job_title, "warehouse")), "data engineer", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "scientist"), "data scientist", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "data")& str_detect(job_title, "analyst|analytics"), "data analyst", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "machine|deep")& str_detect(job_title, "learning"), "deep learning & machine learning", job_title)) %>% 
  mutate(job_title = ifelse(str_detect(job_title, "product") & str_detect(job_title, "analyst|engineer|data"), "data product analyst", job_title)) %>% 
  filter(year == 2018) %>% 
  filter(stem == 1) %>% 
  group_by(job_title) %>% 
  summarise(n = n()) %>%
  arrange(-n) %>% 
  slice(1:20) %>% 
  ggbarplot("job_title", "n", fill = "#00B2E4", color = "white", alpha = 0.8, sort.val = "asc", orientation = "horiz") %>% 
  labs(title = "stem program")
```

