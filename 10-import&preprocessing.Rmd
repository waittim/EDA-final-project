---
title: "00-test"
output: html_notebook
---

## Load packages
```{r}
library(tidyverse)
library(janitor)
library(assertr)
library(stringr)
library(lubridate)
library(zipcode)
library(gganimate)
```


```{r}
# Please unrara the "transformed.rar" file manually first.
original_file <- read_csv("data/transformed.csv") %>% 
  clean_names()
#file.remove("data/transformed.csv")
stem <- read_csv("data/stem_list.csv")
```
#Removing Coli Extraneous  Columns

```{r}
DATA <- original_file %>% 
  select(- c('coli_x', 'coli_y')) %>% 
  mutate(case_status=str_to_lower(case_status)) %>% 
  mutate(employer_name=str_to_lower(employer_name)) %>%  
  mutate(soc_name=str_to_lower(soc_name)) %>%  
  mutate(job_title=str_to_lower(job_title)) %>% 
  mutate(full_time_position = case_when(full_time_position=="Y"~1,
                                        full_time_position=="N"~0)) %>% 
  mutate(full_time_position=factor(full_time_position)) %>% 
  mutate(worksite_city=str_to_lower(worksite_city)) %>% 
  mutate(worksite_state_abb=str_to_upper(worksite_state_abb)) %>% 
  mutate(worksite_state_full=str_to_lower(worksite_state_full)) %>% 
  mutate(worksite=str_to_lower(worksite)) 

head(DATA)
```


# Adding the new feature called `soc_field` to represent the higher level of job fields.
```{r}
DATA <- DATA %>% 
  filter(str_detect(soc_code, "^\\d{2}(-)\\d{4}$")) %>% 
  mutate(soc_field = substr(soc_code, start = 1, stop = 2)) %>% 
  filter(as.numeric(soc_field) %% 2 != 0) %>% 
  filter(soc_field != 71) %>% 
  select(soc_field, soc_code, job_title, everything())
```


# Conform the top tech companies's name
```{r}
DATA <- DATA %>% 
  mutate(employer_name = ifelse(str_detect(employer_name,'apple inc'), 'apple',
                          ifelse(str_detect(employer_name,'microsoft'), 'microsoft',
                          ifelse(str_detect(employer_name,'amazon'),'amazon',
                          ifelse(str_detect(employer_name,'cisco sys'),'cisco',
                          ifelse(str_detect(employer_name,'facebook'),'facebook',
                          ifelse(str_detect(employer_name,'google'),'google',
                          ifelse(str_detect(employer_name, 'ibm'),'ibm', employer_name))))))))
```

# define job level & data related & sde related 
```{r}
DATA <- DATA %>% 
  mutate(job_level=case_when(grepl("senior",job_title) ~ "high level",
                             grepl("director",job_title) ~ "high level",
                             grepl("lead",job_title) ~ "high level",
                             grepl("chief",job_title) ~ "high level",
                             grepl("principal",job_title) ~ "high level",
                             TRUE ~ "undefined")) %>% 
  mutate(data_relation=case_when(grepl("data",job_title) ~ "data_related",
                                 grepl("analy",job_title) ~ "data_related",
                                 grepl("machine learning",job_title) ~ "data_related",
                                 grepl("deep learning",job_title) ~ "data_related",
                                 grepl("intelligence",job_title) ~ "data_related",
                                 grepl("quantitative",job_title) ~ "data_related",
                                 grepl("statistic",job_title) ~ "data_related",
                                 grepl("sas",job_title) ~ "data_related",
                                 grepl("sql",job_title) ~ "data_related",
                                 grepl("oracle",job_title) ~ "data_related",
                                 grepl("spss",job_title) ~ "data_related",
                                 grepl("hadoop",job_title) ~ "data_related",
                                 TRUE ~ "undefined")) %>% 
  mutate(data_relation=case_when(grepl("program",job_title) ~ "undefined",
                                 grepl("system",job_title) ~ "undefined",
                                 grepl("tech",job_title) ~ "undefined",
                                 grepl("comput",job_title) ~ "undefined",
                                 TRUE ~ data_relation)) %>% 
  mutate(data_relation=case_when(grepl("business system analyst",job_title) ~ "data_related",
                                 TRUE ~ data_relation)) %>% 
  mutate(sde_relation=case_when(grepl("software",job_title) ~ "sde_related",
                                grepl("program",job_title) ~ "sde_related",
                                grepl("comput",job_title) ~ "sde_related",
                                grepl("system",job_title) ~ "sde_related",
                                grepl("tech",job_title) ~ "sde_related",
                                grepl("develop",job_title) ~ "sde_related",
                                TRUE ~ "undefined")) 
```

```{r}
DATA <- DATA %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title,"business")&(str_detect(job_title,"analyst")|str_detect(job_title, "intelligence")), 
                  "Business Analyst", 
                  job_title)) %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title, "data")&(str_detect(job_title,"engineer")|str_detect(job_title, "warehouse")),
                  "Data Engineer", 
                  data_job_title)) %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title, "data")&str_detect(job_title, "scientist"), 
                  "Data Scientist", 
                  data_job_title)) %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title, "data")&str_detect(job_title, "analyst|analytics"), 
                  "Data Analyst", 
                  data_job_title)) %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title, "machine|deep")&str_detect(job_title, "learning"), 
                  "Data Scientist", 
                  data_job_title)) %>% 
  mutate(data_job_title = 
           ifelse(str_detect(job_title, "product")&str_detect(job_title, "analyst|engineer|data"), 
                  "Data Product Analyst", 
                  data_job_title)) 
```


# left_join: all stem occupations

```{r}
DATA <- DATA %>% 
  left_join(stem, by = "soc_code")
DATA <- DATA %>% 
  mutate(stem = ifelse(is.na(stem), 0, 1))
```

